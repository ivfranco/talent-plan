export RUSTFLAGS=-Dwarnings
export RUST_TEST_THREADS=1
export RUST_BACKTRACE=1
# using the installation of rust toolchain on host from WSL, by far the most convenient and performant set up on windows
export CARGO=cargo.exe

LOG_LEVEL ?= raft=info,percolator=info

check:
	$(CARGO) fmt --all -- --check
	# since then Rust changed a lot, -D clippy::all blocks compliation of utility libraries 
	$(CARGO) clippy --all --tests -- -W clippy::all

test: test_others test_2 test_3

test_2: test_2a test_2b test_2c

test_2a: cargo_test_2a

test_2b: cargo_test_2b

test_2c: cargo_test_2c

test_3: test_3a test_3b

test_3a: cargo_test_3a

test_3b: cargo_test_3b

cargo_test_%: check
	RUST_LOG=${LOG_LEVEL} $(CARGO) test -p raft --no-fail-fast -- --nocapture --test $*

test_others: check
	RUST_LOG=${LOG_LEVEL} $(CARGO) test -p labrpc -p labcodec -- --nocapture

test_percolator: check
	RUST_LOG=${LOG_LEVEL} $(CARGO) test -p percolator -- --nocapture

# check what's generated by the protobuf library
expand:
	$(CARGO) +nightly rustc --profile=check -p raft -- -Zunstable-options --pretty=expanded | vim -c "set syntax=rust" -
